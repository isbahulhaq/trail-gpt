import asyncio
from playwright.async_api import async_playwright
import nest_asyncio

nest_asyncio.apply()

running = True

async def start(user, wait_time, meetingcode, passcode):
    print(f"[+] {user} started")

    async with async_playwright() as p:
        browser = await p.chromium.launch(
            headless=True,
            args=[
                "--use-fake-device-for-media-stream",
                "--use-fake-ui-for-media-stream",
                "--disable-dev-shm-usage"
            ]
        )

        context = await browser.new_context()
        await context.grant_permissions(["microphone"])
        page = await context.new_page()

        try:
            await page.goto(
                f"https://app.zoom.us/wc/join/{meetingcode}",
                timeout=20000
            )

            for btn in [
                "#onetrust-accept-btn-handler",
                "#wc_agree1"
            ]:
                try:
                    await page.click(btn, timeout=3000)
                except:
                    pass

            await page.fill('input[type="text"]', user)
            await page.fill('input[type="password"]', passcode)

            await page.click("button.preview-join-button", timeout=15000)

            try:
                await page.wait_for_selector(
                    'button[class*="join-audio-by-voip"]',
                    timeout=20000
                )
                await page.click('button[class*="join-audio-by-voip"]')
                print(f"[MIC] {user}")
            except:
                print(f"[NO MIC] {user}")

            while running and wait_time > 0:
                await asyncio.sleep(1)
                wait_time -= 1

        except Exception as e:
            print(f"[ERROR] {user} â†’ {e}")

        await browser.close()
        print(f"[END] {user}")
